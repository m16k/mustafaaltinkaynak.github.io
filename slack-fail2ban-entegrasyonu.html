<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Mustafa ALTINKAYNAK - [SLACK] Fail2ban Entegrasyonu</title>
        <meta name="description" content="" />

        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="shortcut icon" href="https://www.mustafa.com.tr/assets/images/favicon.png">
        <link rel="stylesheet" type="text/css" href="https://www.mustafa.com.tr/theme/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="https://www.mustafa.com.tr/theme/css/custom.css"/>
        <link rel="stylesheet" type="text/css" href="https://www.mustafa.com.tr/theme/css/pygments.css"/>
        <link rel="stylesheet" type="text/css" href="https://www.mustafa.com.tr/theme/css/monosocialiconsfont.css"/>
        <link rel="stylesheet" href="https://www.mustafa.com.tr/theme/tipuesearch/tipuesearch.css">
        <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300&subset=latin,latin-ext' rel='stylesheet' type='text/css'>

        <link href="https://www.mustafa.com.tr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mustafa ALTINKAYNAK Full Atom Feed" />
        <link href="https://www.mustafa.com.tr/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Mustafa ALTINKAYNAK Full RSS Feed" />
        <link href="https://www.mustafa.com.tr/feeds/sistem-yoneticiligi.atom.xml" type="application/atom+xml" rel="alternate" title="Mustafa ALTINKAYNAK Categories Atom Feed" />

<meta name="tags" content="slack" />
<meta name="tags" content="fail2ban" />
    </head>
    <body class="home-template">
        <div class="container">
            <div class="col-md-10 col-md-offset-1 col-sm-12 col-xs-12">
<main class="content" role="main">
    <div class="row">
        <article class="post tag-play tag-security">
          <header class="post-header">
            <a class="blog-logo" href="/">
              <span class="blog-title">Mustafa ALTINKAYNAK</span>
            </a>
          </header>
           
            <h1 class="post-title">[SLACK] Fail2ban Entegrasyonu</h1>


            <section class="post-content">
              <h2>Brute Force Nedir?</h2>
<p>Saldırganların sıklıkla tercih ettikleri tekniklerden biri de Brute Force adı verilen kaba kuvvet saldırılarıdır. Brute force bir program yardımıyla yapılabileceği gibi el ile de yapılabilir. Brute force saldırılarında kullanıcı adı ve parola bilgisi teker teker denenir. Bu saldırıda başarılı olunabilmesi için en çok kullanılan parola dizilimleri yani sözlük denilen listeler kullanılır. Ne kadar geniş bir sözlük varsa başarıya ulaşma imkanı da o kadar yüksek olur.</p>
<p>Uygulamalar brute force saldırılarına yönelik çeşitli aksiyonlar almışlardır. Bazı uygulamalar çok sayıda giriş yapıldığında captcha ile giriş istemekte, bazı uygulamalar ise belirli süre o kullanıcıya ait hesabı kapatmaktadır.</p>
<h2>Fail2Ban Nedir?</h2>
<p>Fail2ban sunucu sistemlerinde servislere ait log kayıtlarının takip edilerek gerektiği durumlarda bu kişilere karşı aksiyon almayı sağlar. Bu kişilere yönelik sizin belirlediğiniz süre kadar sisteme girişlerini yasaklar. Fail2ban iptables firewall'a ilgili kuralı dinamik olarak girmektedir. Ek olarak fail2ban tcpwrapper'la da çalışabilmektedir.</p>
<p>Şu sıralar epeyi Slack ile haşır neşir olmaya ve gittikçe sevmeye başladım. Şimdi fail2ban'ın almış olduğu aksiyonlardan anında haberdar olabilmek için Slack ile entegrasyon edelim.</p>
<p>NOT: Bu tarz durumlar için e-posta kullanmayı pek sevmediğimden dolayı, e-posta ile notification almak istemiyorum. Tercihim bu yüzden Slack'den yana.</p>
<h2>Fail2ban Slack Entegrasyonu</h2>
<p>Fail2ban uygulamasına ait yapılandırma ayarları <strong>/etc/fail2ban/jail.conf</strong> dosyasında tutulmaktadır. Ancak custom (özelleştirilmiş) yapılandırma ihtiyaçlarında bu dosyanın bir kopyası üzerinden devam edilmesi önerilir.</p>
<div class="highlight"><pre><span class="code-line"><span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.</span><span class="n">local</span></span>
</pre></div>


<p>Artık değişikliklerimizi <strong>jail.local</strong> dosyası üzerinden gerçekleştireceğiz. Slack için action durumunu ayarlayalım.</p>
<div class="highlight"><pre><span class="code-line"><span class="n">action_with_slack_notification</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">banaction</span><span class="p">)</span><span class="n">s</span><span class="p">[</span><span class="n">name</span><span class="o">=%</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s">&quot;%(port)s&quot;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s">&quot;%(protocol)s&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="s">&quot;%(chain)s&quot;</span><span class="p">]</span></span>
<span class="code-line">                                 <span class="n">slack</span><span class="p">[</span><span class="n">name</span><span class="o">=%</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s">&quot;%(protocol)s&quot;</span><span class="p">]</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="cp"># Choose default action.  To change, just override value of &#39;action&#39; with the</span></span>
<span class="code-line"><span class="cp"># interpolation to the chosen action shortcut (e.g.  action_mw, action_mwl, etc) in jail.local</span></span>
<span class="code-line"><span class="cp"># globally (section [DEFAULT]) or per specific section</span></span>
<span class="code-line"><span class="n">action</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">action_with_slack_notification</span><span class="p">)</span><span class="n">s</span></span>
</pre></div>


<p>Slack için bildirimlerde kullanacağımız betiği oluşturmak için ilgili dizine gidelim.</p>
<div class="highlight"><pre><span class="code-line"><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">action</span><span class="p">.</span><span class="n">d</span></span>
</pre></div>


<p>Şimdi slack bildirimleri için <strong>slack-notify.sh</strong> adında betiğimizi oluşturalım.</p>
<div class="highlight"><pre><span class="code-line"># !/bin/bash</span>
<span class="code-line"># Dosya: /etc/fail2ban/action.d/slack-notify.sh</span>
<span class="code-line">MESSAGE=$1</span>
<span class="code-line">HOOK_URL={HOOK_URL} # https://hooks.slack.com/services/1111111/1111111111111</span>
<span class="code-line">HOST=$(hostname)</span>
<span class="code-line"></span>
<span class="code-line">CHANNEL=&quot;#alerts&quot; # Hangi kanala gönderim yapılacak</span>
<span class="code-line">USERNAME=&quot;fail2ban&quot; # Hangi kullanıcı adıyla gönderim yapılacak</span>
<span class="code-line">ICON=&quot;:bangbang:&quot; # Mesajlarda kullanılacak icon -&gt; http://www.webpagefx.com/tools/emoji-cheat-sheet/</span>
<span class="code-line"></span>
<span class="code-line">if [ &quot;$#&quot; -ge 2 ]; then</span>
<span class="code-line">    IP=$2</span>
<span class="code-line">    # İsteğin hangi ülkeden geldiği</span>
<span class="code-line">    COUNTRY=$(curl ipinfo.io/<span class="cp">${</span><span class="n">IP</span><span class="cp">}</span>/country)</span>
<span class="code-line"></span>
<span class="code-line">    COUNTRY=$(echo &quot;<span class="nv">$COUNTRY</span>&quot; | tr -s  &#39;[:upper:]&#39;  &#39;[:lower:]&#39;)</span>
<span class="code-line">    # Ülkeye uygun emoji setleniyor.</span>
<span class="code-line">    COUNTRY=&quot;:flag-<span class="nv">$COUNTRY</span>:&quot;</span>
<span class="code-line">    MESSAGE=&quot;<span class="cp">${</span><span class="n">MESSAGE</span><span class="o">/</span><span class="n">_country_</span><span class="o">/</span><span class="err">$</span><span class="n">COUNTRY</span><span class="cp">}</span>&quot;</span>
<span class="code-line">fi</span>
<span class="code-line"></span>
<span class="code-line"># Curl isteği gerçekleştiriyoruz.</span>
<span class="code-line">curl -X POST --data-urlencode &quot;payload={\&quot;channel\&quot;: \&quot;<span class="cp">${</span><span class="n">CHANNEL</span><span class="cp">}</span>\&quot;, \&quot;username\&quot;: \&quot;<span class="cp">${</span><span class="n">USERNAME</span><span class="cp">}</span>\&quot;, \&quot;text\&quot;: \&quot;[*<span class="cp">${</span><span class="n">HOST</span><span class="cp">}</span>*] <span class="cp">${</span><span class="n">MESSAGE</span><span class="cp">}</span>\&quot;, \&quot;icon_emoji\&quot;: \&quot;<span class="cp">${</span><span class="n">ICON</span><span class="cp">}</span>\&quot;$</span>
<span class="code-line"></span>
<span class="code-line">exit 0</span>
</pre></div>


<p>Bildirim betiğimiz hazır. Şimdi hangi durumlarda çalışması gerektiğini belirliyoruz.</p>
<div class="highlight"><pre><span class="code-line"><span class="err">#</span> <span class="nx">Dosya</span><span class="p">:</span> <span class="p">/</span><span class="nx">etc</span><span class="p">/</span><span class="nx">fail2ban</span><span class="p">/</span><span class="nx">action.d</span><span class="p">/</span><span class="nx">slack.conf</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="err">[</span><span class="nx">Definition</span><span class="cp">]</span></span>
<span class="code-line"></span>
<span class="code-line">actioncheck=</span>
<span class="code-line">actionstart = /bin/bash /etc/fail2ban/action.d/slack-notify.sh &quot;The jail <span class="nt">&lt;name&gt;</span> has been started successfully.&quot; &gt; /dev/null 2&gt;<span class="err">&amp;</span>1</span>
<span class="code-line">actionstop = /bin/bash /etc/fail2ban/action.d/slack-notify.sh &quot;The jail <span class="nt">&lt;name&gt;</span> has been stopped.&quot; &gt; /dev/null 2&gt;<span class="err">&amp;</span>1</span>
<span class="code-line">actionban = /bin/bash /etc/fail2ban/action.d/slack-notify.sh &quot;Banned _country_ <span class="nt">&lt;ip&gt;</span> in the jail <span class="nt">&lt;name&gt;</span> after <span class="nt">&lt;failures&gt;</span> attempts&quot; &quot;<span class="nt">&lt;ip&gt;</span>&quot; &gt; /dev/null 2&gt;<span class="err">&amp;</span>1</span>
<span class="code-line">actionunban = /bin/bash /etc/fail2ban/action.d/slack-notify.sh &quot;Unbanned _country_ <span class="nt">&lt;ip&gt;</span> in the jail <span class="nt">&lt;name&gt;</span>&quot; &quot;<span class="nt">&lt;ip&gt;</span>&quot; &gt; /dev/null 2&gt;<span class="err">&amp;</span>1</span>
<span class="code-line"></span>
<span class="code-line"># Default name of the chain</span>
<span class="code-line">#</span>
<span class="code-line">name = default</span>
</pre></div>


<p>Artık servis başladığında, durduğunda, bir kullanıcı sistemden atıldığı ve yasaklamasının kaldırıldığı durumda bildirim gelecektir.</p>
<p><img alt="" src="assets/images/fail2ban_slack.jpg" /></p>
            </section>

            <footer class="post-footer">
                <section>
                  <span class="post-meta">
                    Tags:                     <a href="https://www.mustafa.com.tr/tag/slack.html">slack</a>,                     <a href="https://www.mustafa.com.tr/tag/fail2ban.html">fail2ban</a>                  </span>
                </section>

                <section class="share">
                    <h4>Share this post</h4>
                    <a class="icon-twitter" href="http://twitter.com/share?text=[SLACK] Fail2ban Entegrasyonu&url=https://www.mustafa.com.tr/slack-fail2ban-entegrasyonu.html"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                        <span class="hidden">Twitter</span>
                        <span class='symbol'>circletwitterbird</span>
                    </a>
                    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.mustafa.com.tr/slack-fail2ban-entegrasyonu.html"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                        <span class="hidden">Facebook</span>
                        <span class='symbol'>circlefacebook</span>
                    </a>
                    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://www.mustafa.com.tr/slack-fail2ban-entegrasyonu.html"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                        <span class="hidden">Google+</span>
                        <span class='symbol'>circlegoogleplus</span>
                    </a>
                </section>

            </footer>

            <div id="disqus_thread"></div>
            <script>
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//mustafaaltinkaynak.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </article>
    </div>
</main>
                <footer class="site-footer">
                    <a class="subscribe icon-feed" href="https://www.mustafa.com.tr/feeds/all.rss"><span class="tooltip"><span class="symbol">blip</span></span></a>
                    <a class="subscribe icon-feed" href="https://www.mustafa.com.tr/archives.html"><span class="tooltip"><span class="symbol">star</span></span></a>
                    <div class="inner">
                         <section class="copyright">mustafaaltinkaynak &copy; 2017</section>
                    </div>
                </footer>

                <!-- Yandex.Metrika counter -->
                <script type="text/javascript">
                    (function (d, w, c) {
                        (w[c] = w[c] || []).push(function() {
                            try {
                                w.yaCounter39549065 = new Ya.Metrika({
                                    id:39549065,
                                    clickmap:true,
                                    trackLinks:true,
                                    accurateTrackBounce:true
                                });
                            } catch(e) { }
                        });

                        var n = d.getElementsByTagName("script")[0],
                            s = d.createElement("script"),
                            f = function () { n.parentNode.insertBefore(s, n); };
                        s.type = "text/javascript";
                        s.async = true;
                        s.src = "https://mc.yandex.ru/metrika/watch.js";

                        if (w.opera == "[object Opera]") {
                            d.addEventListener("DOMContentLoaded", f, false);
                        } else { f(); }
                    })(document, window, "yandex_metrika_callbacks");
                </script>
                <noscript><div><img src="https://mc.yandex.ru/watch/39549065" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
                <!-- /Yandex.Metrika counter -->


            </div>
        </div>
    </body>
</html>